<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.chord {
  fill-opacity: .67;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var outerRadius = 1000 / 2,
    innerRadius = outerRadius - 200;

var fill = d3.scale.category10();

var chord = d3.layout.chord()
    .padding(.04)
    .sortChords(d3.descending);

var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(innerRadius + 20);

var svg = d3.select("body").append("svg")
    .attr("width", outerRadius * 2)
    .attr("height", outerRadius * 2)
    .append("g")
    .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");

function fade(opacity) {
  return function(g, i) {
    svg.selectAll("path.chord")
        .filter(function(d) { return d.source.index != i && d.target.index != i; })
        .transition()
        .style("opacity", opacity);
  };
}

d3.json("chord_diagram.json", function(error, data) {
  if (error) throw error;
  var topics = data['topics'];
  var matrix = data['topic_matrix'];
  chord.matrix(matrix);
  var g = svg.selectAll(".group")
      .data(chord.groups)
      .enter().append("g")
      .attr("class", "group");

  g.append("path")
      .style("fill", function(d) { return fill(d.index); })
      .style("stroke", function(d) { return fill(d.index); })
      .attr("d", arc)
      .on("mouseover", fade(.05))
      .on("mouseout", fade(1));

  // var quad2angle = [90, -95, -95, 85];
  g.append("text")
      .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
      .attr("dy", ".35em")
      .attr("transform", function(d) {
        var degree = d.angle * 180 / Math.PI;
        // var quadrant = Math.floor(degree/90);
        return "rotate(" + (degree - 90) + ")"
            + "translate(" + (innerRadius + 26) + ")"
            // + "rotate(" + (d.angle + quad2angle[quadrant]) + ")";
            + (d.angle > Math.PI ? "rotate(180)" : "");
      })
      .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
      // .style("text-anchor", "middle")
      .text(function(d) { return topics[d.index]; });

  svg.selectAll(".chord")
      .data(chord.chords)
      .enter().append("path")
      .attr("class", "chord")
      .style("stroke", function(d) { return d3.rgb(fill(d.source.index)).darker(); })
      .style("fill", function(d) { return fill(d.source.index); })
      .attr("d", d3.svg.chord().radius(innerRadius));

});

d3.select(self.frameElement).style("height", outerRadius * 2 + "px");

</script>
